<!DOCTYPE html>
<html>
<head>
    <title>Chat Application</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<noscript><h2 style="color: #ff0000">Seems your browser doesn't support Javascript! Websocket relies on Javascript being enabled. Please enable Javascript and reload this page!</h2></noscript>

<div id="main-content" class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>Chat Application</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <form class="form-inline">
                <div class="form-group">
                    <label for="authToken">Authorization:</label>
                    <input type="text" id="authToken" class="form-control" placeholder="Enter Authorization Token">
                </div>
                <div class="form-group">
                    <label for="chatRoomId">Chat Room ID:</label>
                    <input type="text" id="chatRoomId" class="form-control" placeholder="Enter Chat Room ID">
                </div>
            </form>
            <button id="connect" class="btn btn-default" onclick="connect()">Connect</button>
            <button id="disconnect" class="btn btn-default" onclick="disconnect()">Disconnect</button>
            <button id="enter" class="btn btn-default" onclick="enter()">Enter</button>
        </div>
        <div class="col-md-6">
            <form class="form-inline">
                <div class="form-group">
                    <label for="message">Message:</label>
                    <input type="text" id="message" class="form-control" placeholder="Enter your message">
                </div>
            </form>
            <button id="send" class="btn btn-default" onclick="sendMessage()">Send</button>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table id="conversation" class="table table-striped">
                <thead>
                <tr>
                    <th>Messages</th>
                </tr>
                </thead>
                <tbody id="messages">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    var stompClient = null;

    function connect() {
        var socket = new SockJS('/stomp/chat');
        stompClient = Stomp.over(socket);

        var authToken = document.getElementById("authToken").value;
        var headers = {
            'Authorization': authToken
        };

        stompClient.connect(headers, function (frame) {
            console.log('Connected: ' + frame);
            var chatRoomId = document.getElementById("chatRoomId").value;
            stompClient.subscribe('/sub/' + chatRoomId, function (message) {
                showMessage(JSON.parse(message.body).contents);
            });
            stompClient.send("/pub/connect", headers, JSON.stringify({
                'messageType': 'SEND',
                'chatRoomId': chatRoomId,
                'senderRole': 'CUSTOMER',
                'contents': 'Connected to chat room'
            }));
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            var chatRoomId = document.getElementById("chatRoomId").value;
            stompClient.send("/pub/disconnect", {}, JSON.stringify({
                'messageType': 'SEND',
                'chatRoomId': chatRoomId,
                'senderRole': 'CUSTOMER',
                'contents': 'Disconnected from chat room'
            }));
            stompClient.disconnect();
            console.log("Disconnected");
        }
    }

    function enter() {
        var chatRoomId = document.getElementById("chatRoomId").value;
        stompClient.send("/pub/shared/enter", {}, JSON.stringify({
            'messageType': 'SEND',
            'chatRoomId': chatRoomId,
            'senderRole': 'CUSTOMER',
            'contents': 'Entered the chat room'
        }));
    }

    function sendMessage() {
        var chatRoomId = document.getElementById("chatRoomId").value;
        var message = document.getElementById("message").value;
        stompClient.send("/pub/customer/send", {}, JSON.stringify({
            'messageType': 'SEND',
            'chatRoomId': chatRoomId,
            'senderRole': 'CUSTOMER',
            'contents': message
        }));
    }

    function showMessage(message) {
        var messagesElement = document.getElementById("messages");
        var newRow = messagesElement.insertRow();
        var newCell = newRow.insertCell(0);
        var newText = document.createTextNode(message);
        newCell.appendChild(newText);
    }
</script>

</body>
</html>
